name: Android [Dev] ìµœì‹  ë²„ì „ ë°°í¬ # ì•± ë°°í¬ ì œëª©

on:
  push:
    branches: [ release ] # releaseìœ¼ë¡œ PRì„ ë‚ ë¦´ë•Œë§Œ íŠ¸ë¦¬ê±° ë˜ë„ë¡ ì •ì˜

jobs: # ì•„ë˜ì— workflow ê¸°ëŠ¥ ì •ì˜í•œë‹¤.
  build: # ë¹Œë“œ ìˆœì„œë¥¼ ì •í•œë‹¤.
    runs-on: ubuntu-latest # ubuntu ë°°í¬ë²„ì „ì—ì„œ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •
    steps: # ë‹¨ê³„ë³„ë¡œ ìˆ˜í–‰í•´ì•¼í•˜ëŠ” ì‘ì—…ì„ ì •ì˜í•œë‹¤. në²ˆì§¸ ë‹¨ê³„ê°€ ì‹¤íŒ¨í•˜ë©´, n+1 ë‹¨ê³„ëŠ” ì·¨ì†Œë¨.
      - uses: actions/checkout@v3

      - name: Decode release.keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > release.keystore

      - name: Generate local.properties
        run: |
          echo BASE_URL=\"${{ secrets.BASE_URL }}\" >> local.properties
          echo KAKAO_NATIVE_APP_KEY=\"${{ secrets.KAKAO_NATIVE_APP_KEY }}\" >> local.properties
          echo SCHEME_KAKAO_APP_KEY=\"kakao${{ secrets.KAKAO_NATIVE_APP_KEY }}\" >> local.properties
          echo SERVICE_API_KEY=${{ secrets.SERVICE_API_KEY }} >> local.properties
          
          echo storeFile=release.keystore >> local.properties
          echo storePassword=${{ secrets.STORE_PASSWORD }} >> local.properties
          echo keyAlias=${{ secrets.KEY_ALIAS }} >> local.properties
          echo keyPassword=${{ secrets.KEY_PASSWORD }} >> local.properties

      - name: set up JDK 17
        uses: actions/setup-java@v1
        with:
          java-version: 17

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/buildSrc/**/*.kt') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        run: chmod +x ./gradlew

        # debug ë²„ì „ ë¹Œë“œ ì‹œì‘
      - name: build debug
        run: bash ./gradlew assembleDebug --stacktrace

      - name: Firebase Deploy # Firebase ë°°í¬ ì‹œì‘
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{secrets.FIREBASE_APP_ID}} # Github Settign - Secretì— Firebase ì •ë³´ë¥¼ ì €ì¥í•´ë†“ìŒ.
          token: ${{secrets.FIREBASE_TOKEN}} # clië¥¼ í†µí•´ Firebase Projectì˜ Tokenì„ ì €ì¥í•´ë†“ìŒ.
          groups: PillMate # í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ê·¸ë£¹
          file: app/build/outputs/apk/debug/app-debug.apk

      - name: Post to a Slack channel
        id: slack
        uses: slackapi/slack-github-action@v1.18.0
        with:
          #repo-token: ${{ secrets.GIT_TOKEN }}
          channel-id: 'C08Q5EZ4FNV'
          slack-message: |
            ğŸš€ ìƒˆë¡œìš´ í…ŒìŠ¤íŠ¸ ë¹Œë“œê°€ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!
            ğŸ‘‰ ì»¤ë°‹ ë©”ì‹œì§€: ${{ github.event.head_commit.message }}
          #file_path: 'app/build/outputs/apk/debug/app-debug.apk'
          #file_name: 'app-debug.apk'
          #file_type: 'apk'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_TOKEN }}